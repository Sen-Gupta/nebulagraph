# Copyright 2022 The Dapr Authors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

services:
  # NebulaGraph Meta Service
  nebula-metad:
    image: vesoft/nebula-metad:v3.8.0
    container_name: nebula-metad
    restart: unless-stopped
    ports:
      - "${NEBULA_META_PORT}:${NEBULA_META_PORT}"
      - "${NEBULA_META_HTTP_PORT}:${NEBULA_META_HTTP_PORT}"
    environment:
      - USER=root
    volumes:
      - nebula-meta:/usr/local/nebula/data
      - nebula-logs:/usr/local/nebula/logs
    networks:
      - dapr-pluggable-net
    command:
      - --meta_server_addrs=nebula-metad:${NEBULA_META_PORT}
      - --local_ip=nebula-metad
      - --ws_ip=nebula-metad
      - --port=${NEBULA_META_PORT}
      - --ws_http_port=${NEBULA_META_HTTP_PORT}

  # NebulaGraph Storage Service
  nebula-storaged:
    image: vesoft/nebula-storaged:v3.8.0
    container_name: nebula-storaged
    restart: unless-stopped
    ports:
      - "${NEBULA_STORAGE_PORT}:${NEBULA_STORAGE_PORT}"
      - "${NEBULA_STORAGE_HTTP_PORT}:${NEBULA_STORAGE_HTTP_PORT}"
    environment:
      - USER=root
    volumes:
      - nebula-storage:/usr/local/nebula/data
      - nebula-logs:/usr/local/nebula/logs
    networks:
      - dapr-pluggable-net
    depends_on:
      - nebula-metad
    command:
      - --meta_server_addrs=nebula-metad:${NEBULA_META_PORT}
      - --local_ip=nebula-storaged
      - --ws_ip=nebula-storaged
      - --port=${NEBULA_STORAGE_PORT}
      - --ws_http_port=${NEBULA_STORAGE_HTTP_PORT}

  # NebulaGraph Graph Service
  nebula-graphd:
    image: vesoft/nebula-graphd:v3.8.0
    container_name: nebula-graphd
    restart: unless-stopped
    ports:
      - "${NEBULA_PORT}:${NEBULA_PORT}"
      - "${NEBULA_HTTP_PORT}:${NEBULA_HTTP_PORT}"
    environment:
      - USER=root
    volumes:
      - nebula-data:/usr/local/nebula/data
      - nebula-logs:/usr/local/nebula/logs
    networks:
      - dapr-pluggable-net
    depends_on:
      - nebula-metad
      - nebula-storaged
    command:
      - --meta_server_addrs=nebula-metad:${NEBULA_META_PORT}
      - --local_ip=nebula-graphd
      - --ws_ip=nebula-graphd
      - --port=${NEBULA_PORT}
      - --ws_http_port=${NEBULA_HTTP_PORT}

  # NebulaGraph Console (for management)
  nebula-console:
    image: vesoft/nebula-console:v3.8.0
    container_name: nebula-console
    networks:
      - dapr-pluggable-net
    depends_on:
      - nebula-graphd
    stdin_open: true
    tty: true
    command: ["nebula-console", "-addr", "nebula-graphd", "-port", "${NEBULA_PORT}", "-u", "root", "-p", "nebula"]

  # NebulaGraph Studio (web-based management interface)
  nebula-studio:
    image: vesoft/nebula-graph-studio:v3.8.0
    container_name: nebula-studio
    environment:
      - USER=root
    networks:
      - dapr-pluggable-net
    ports:
      - "${NEBULA_STUDIO_PORT}:7001"
    depends_on:
      - nebula-graphd
    volumes:
      - nebula-studio-data:/root/nebula-graph-studio/db

volumes:
  nebula-data:
  nebula-meta:
  nebula-storage:
  nebula-logs:
  nebula-studio-data:

networks:
  dapr-pluggable-net:
    external: true
    name: ${DAPR_PLUGABBLE_NETWORK_NAME:-dapr-pluggable-net}
