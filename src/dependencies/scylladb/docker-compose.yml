# Copyright 2022 The Dapr Authors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

services:
  # ScyllaDB Primary Node
  scylladb-node1:
    image: scylladb/scylla:5.4.6
    container_name: scylladb-node1
    restart: unless-stopped
    ports:
      - "9042:9042"      # CQL Native Protocol
      - "7199:7199"      # JMX
      - "10000:10000"    # REST API
      - "9180:9180"      # Prometheus metrics
      - "7002:7000"      # Inter-node communication (changed from 7000 to 7002)
      - "7003:7001"      # SSL Inter-node communication (changed from 7001 to 7003)
    volumes:
      - scylla-data-node1:/var/lib/scylla
      - scylla-config:/etc/scylla
    networks:
      - scylla-net
    command: 
      - --seeds=scylladb-node1
      - --smp=1
      - --memory=1G
      - --overprovisioned=1
      - --api-address=0.0.0.0
      - --listen-address=0.0.0.0
      - --rpc-address=0.0.0.0
      - --broadcast-address=scylladb-node1
      - --broadcast-rpc-address=scylladb-node1
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'SELECT now() FROM system.local;' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 90s

  # ScyllaDB Web Console (optional)
  scylla-manager:
    image: scylladb/scylla-manager:3.2.6
    container_name: scylla-manager
    restart: unless-stopped
    ports:
      - "5081:5080"      # Manager Web UI (changed from 5080 to 5081)
      - "5091:5090"      # Manager API (changed from 5090 to 5091)
    environment:
      - SCYLLA_MANAGER_DB_HOSTS=scylladb-node1:9042
    networks:
      - scylla-net
    depends_on:
      - scylladb-node1
    volumes:
      - scylla-manager-data:/etc/scylla-manager

volumes:
  scylla-data-node1:
  scylla-config:
  scylla-manager-data:

networks:
  scylla-net:
    driver: bridge
