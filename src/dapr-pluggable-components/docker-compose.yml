# Copyright 2022 The Dapr Authors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

services:
  # Dapr Pluggable Component (Multi-Store Support)
  dapr-pluggable-component:
    container_name: dapr-pluggable-component
    build:
      context: .  # Current directory contains the Dockerfile
      dockerfile: Dockerfile
    environment:
      - DAPR_COMPONENT_SOCKETS_FOLDER=/var/run
      - STORE_TYPES=nebulagraph,scylladb
    volumes:
      - socket:/var/run
    networks:
      - dapr-pluggable-net

  # Dapr runtime sidecar
  dapr-pluggable-component-sidecar:
    container_name: dapr-pluggable-component-sidecar
    restart: on-failure
    image: "ghcr.io/dapr/daprd:latest"
    command: [
      "./daprd",
      "--log-level=debug",
      "--app-id", "dual-state-test",
      "--dapr-http-port", "${DUAL_HTTP_PORT:-3502}",
      "--placement-host-address", "dapr-placement:${DAPR_PLACEMENT_PORT:-50090}",
      "--scheduler-host-address", "dapr-scheduler:${DAPR_SCHEDULER_PORT:-50091}",
      "--resources-path", "/components",
      "--config", "/components/config.yaml"
    ]
    environment:
      - DAPR_COMPONENTS_SOCKETS_FOLDER=/var/run
    env_file:
      - ../.env
    depends_on:
      - dapr-pluggable-component
    ports:
      - "${DUAL_HTTP_PORT:-3502}:${DUAL_HTTP_PORT:-3502}"  # Dapr HTTP API
      - "${DUAL_GRPC_PORT:-50002}:${DUAL_GRPC_PORT:-50002}"  # Dapr gRPC API
    volumes:
      - socket:/var/run
      # Mount component files and secrets
      - ../components:/components:ro
      - ../secrets:/secrets:ro
    networks:
      - dapr-pluggable-net

  # Test application (optional)
  nebulagraph-test-app:
    container_name: nebulagraph-test-app
    build:
      context: ../../  # Point to dapr-pluggable-components root directory
      dockerfile: Dockerfile.test
    environment:
      - DAPR_HTTP_ENDPOINT=http://dapr-pluggable-component-sidecar:${DUAL_HTTP_PORT:-3502}
      - DAPR_GRPC_ENDPOINT=dapr-pluggable-component-sidecar:${DUAL_GRPC_PORT:-50002}
    depends_on:
      - dapr-pluggable-component-sidecar
    networks:
      - dapr-pluggable-net

volumes:
  socket:

networks:
  dapr-pluggable-net:
    external: true
    name: ${DAPR_PLUGABBLE_NETWORK_NAME:-dapr-pluggable-net}
